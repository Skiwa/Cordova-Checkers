<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="main"></div>

    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/Plateau.js"></script>
    <script src="js/Jeu.js"></script>
    <script src="js/Pion.js"></script>
    <script src="js/Login.js"></script>
    <script src="js/socket.io.js"></script>
    <script>
      /* -- Options -- */
      const modeSolo = false; //jeu de dames en solo
      const adresseServeur = "http://192.168.1.18"; //Adresse du serveur
      const portServeur = 3000; //Port du serveur, par défaut à 3000

      var jeu;
      if (!modeSolo) {
        console.log(
          "%c -- Jeu lancé en mode multijoueur -- ",
          "background: #222; color: #AFDA54;font-size:1.2em"
        );

        //pour se connecter au serveur
        var socket = io.connect(adresseServeur + ":" + portServeur);
        //Lorsque des messages arrivent, appelle la fonction de callback qui affiche une boîte de dialogue
        socket.on("connection_ok", function() {
          //Crée et affiche le formulaire de connexion
          let loginFormClass = new Login();

          //Récupère le formulaire dans le DOM
          let form = document.getElementById("theForm");

          //Informe le serveur lorsqu'un pseudo a été entré
          form.onsubmit = function() {
            // Récupération du pseudo et du mot de passe inséré par l'utilisateur
            let pseudo = form.pseudo.value;
            let password = form.password.value;
            console.log("on a submit ! Bienvenue " + pseudo);
            socket.emit("login", pseudo, password);

            socket.on("notReady", function(msg) {
              console.log(msg);
              //Affiche l'écran d'attente d'adversaire
              loginFormClass.attenteScreen();
            });

            socket.on("ready", function(msg) {
              console.log(JSON.parse(msg));

              //Lance un jeu avec la couleur du joueur fixée par le serveur
              jeu = new Jeu(modeSolo, JSON.parse(msg).yourColor);

              //Le jeu émet un évènement à chaque deplacement du joueur
              jeu.eventTarget.addEventListener("jeu--deplacement", function(
                event
              ) {
                console.log("Le joueur a joué : ", event.detail);

                //Envoie le déplacement effectué au serveur
                //Envoie un objet de type {anciennePosition:{x: x, y: y},nouvellePosition:{x: x, y: y}}
                socket.emit("deplacement-joueur-envoi", event.detail);

                //Vérifie si la partie est terminée
                if (jeu.isOver) {
                  socket.emit("finPartie", pseudo);
                  console.log("C'est fini vous avez gagné !");

                }
              });

              //Un ennemi a joué.
              //Recoit un objet de type {anciennePosition:{x: x, y: y},nouvellePosition:{x: x, y: y}}
              socket.on("deplacement-joueur-reception", function(deplacement) {
                console.log("Ennemi joue", deplacement);
                jeu.ennemiJoue(
                  deplacement.anciennePosition,
                  deplacement.nouvellePosition
                );
                //Vérifie si la partie est terminée
                if (jeu.isOver) {
                  console.log("C'est fini vous avez perdu !");
                }
              });
            });
            //form.onsubmit retourne false pour empêcher le rafraîchissement de la page
            return false;
          };
        });
      } else {
        console.log(
          "%c -- Jeu lancé en mode solo --",
          "background: #222; color: #AFDA54;font-size:1.25em"
        );
        jeu = new Jeu(modeSolo);
      }
    </script>
  </body>
</html>
